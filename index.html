<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>PTN Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f7fa;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    h2 {
      margin-top: 20px;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      background: #3498db;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #2980b9;
    }
    iframe {
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      width: 100%;
      min-height: 600px;
      margin-bottom: 20px;
    }

    /* Link thư mục */
    .folder-links a {
      display: block;
      margin: 6px 0;
      padding: 8px 12px;
      background: #ecf0f1;
      border-radius: 6px;
      color: #2980b9;
      font-weight: bold;
      text-decoration: none;
      transition: 0.2s;
    }
    .folder-links a:hover {
      background: #d6eaf8;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>PTN Dashboard</h1> 
  <!-- Google Drive folders -->
  <h2>Các thư mục quan trọng</h2> 
  <div class="folder-links">
    <a href="https://drive.google.com/drive/folders/1yed3TBGnktmakcwekL60fOOOBgousdA_?usp=sharing">Ảnh thí nghiệm</a>
    <a href="https://drive.google.com/drive/folders/1Onjlnxh62Br5QglU_YCJ67jG8JYt6nBn?usp=sharing">Yêu cầu thí nghiệm</a>
    <a href="https://drive.google.com/drive/folders/11DVnrcLxa3NHv-Y23emDZ36Lob3BwB9N?usp=sharing">Biểu nhập số thí nghiệm</a>
  </div>

  <!-- Camera -->
  <h2>Chụp ảnh thí nghiệm</h2> 

  <!-- PC: thông báo -->
  <div id="pcCamera">
    <p>Truy cập bằng điện thoại để chụp hình và upload. Sau khi chụp xong, nhấn upload, hình ảnh sẽ vào thư mục drive Ảnh thí nghiệm</p>
  </div>

  <!-- Mobile camera -->
  <div id="mobileCamera" style="display:none;">
    <input type="file" accept="image/*" capture="environment" id="cameraInput">
    <button id="uploadBtn">Upload (Mobile)</button>
  </div>
  <hr>
  <!-- SHEETS -->
  <h2>Theo dõi tiến độ hố khoan</h2>
  <!-- Google Sheets -->
  <iframe src="https://docs.google.com/spreadsheets/d/1AK0M8PP_fl7AWb3VjSbuUXt6WBXlNKOynNmJ1cxKr_U/edit?usp=sharing"></iframe>
  <hr>

  <!-- Form + Sheets -->
  <h2>Công việc & Theo dõi</h2>
  <!-- Google Form -->
  <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSfRll9yQzmv5t9OHBKAZFYpNKtb6chKqn8lcJ3nfc1U8NFEiA/viewform?embedded=true"></iframe>

  <!-- Google Sheets -->
  <iframe src="https://docs.google.com/spreadsheets/d/1t6ZJf5wu2iSf5spfFx-fP8tT9-AZUEQ-17xUn8YiSMo/edit?usp=sharing"></iframe>
  <hr>

  
</body>

<script>
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);

  // Nếu là mobile thì hiện input upload
  if (isMobile) {
    document.getElementById('pcCamera').style.display = 'none';
    document.getElementById('mobileCamera').style.display = 'block';
  }

  // Mobile: upload từ input file
  const input = document.getElementById('cameraInput');
  const uploadBtn = document.getElementById('uploadBtn');
  if (uploadBtn) {
    uploadBtn.onclick = () => {
      if (!input.files.length) {
        alert("Chưa chọn ảnh");
        return;
      }
      const file = input.files[0];
      const ext = file.name.split('.').pop().toLowerCase();   // lấy đuôi gốc
      const reader = new FileReader();
      reader.onloadend = () => {
        uploadImage(reader.result, "mobile_" + Date.now() + "." + ext);
      };
      reader.readAsDataURL(file);
    };
  }
  // Hàm resize & upload
  function uploadImage(dataUrl, filename, maxWidth = 1024, maxHeight = 1024) {
    const img = new Image();
    img.onload = () => {
      let width = img.width;
      let height = img.height;
      const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
      width *= ratio;
      height *= ratio;

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      const resizedDataUrl = canvas.toDataURL("image/jpeg", 0.8);
      const mimeMatch = resizedDataUrl.match(/^data:(image\/\w+);base64,/);
      const mimeType = mimeMatch ? mimeMatch[1] : "image/jpeg";
      const base64Data = resizedDataUrl.replace(/^data:image\/\w+;base64,/, "").replace(/\s/g, "");

      fetch("/.netlify/functions/uploadProxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          image: base64Data,
          filename: filename,
          mimeType: mimeType
        })
      })
      .then(res => res.json())
      .then(txt => {
        if(txt.status === "success") {
          alert("Uploaded: " + txt.fileUrl);
        } else {
          alert("Upload error: " + txt.message);
        }
      })
      .catch(err => alert("Upload failed: " + err));
    };
    img.src = dataUrl;
  }
</script>

</html>








