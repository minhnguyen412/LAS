<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>PTN Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f7fa;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    h2 {
      margin-top: 20px;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      background: #3498db;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #2980b9;
    }
    iframe {
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      width: 100%;
      min-height: 600px;
      margin-bottom: 20px;
    }

    /* Link thư mục */
    .folder-links a {
      display: block;
      margin: 6px 0;
      padding: 8px 12px;
      background: #ecf0f1;
      border-radius: 6px;
      color: #2980b9;
      font-weight: bold;
      text-decoration: none;
      transition: 0.2s;
    }
    .folder-links a:hover {
      background: #d6eaf8;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>PTN Dashboard</h1> 
  <!-- Google Drive folders -->
  <h2>Các thư mục quan trọng</h2> 
  <div class="folder-links">
    <a href="https://drive.google.com/drive/folders/1yed3TBGnktmakcwekL60fOOOBgousdA_?usp=sharing">Ảnh thí nghiệm</a>
    <a href="https://drive.google.com/drive/folders/1Onjlnxh62Br5QglU_YCJ67jG8JYt6nBn?usp=sharing">Yêu cầu thí nghiệm</a>
    <a href="https://drive.google.com/drive/folders/11DVnrcLxa3NHv-Y23emDZ36Lob3BwB9N?usp=sharing">Biểu nhập số thí nghiệm</a>
  </div>

  <!-- Camera -->
  <h2>Chụp ảnh thí nghiệm</h2> 

  <!-- PC: thông báo -->
  <div id="pcCamera">
    <p>Truy cập bằng điện thoại để chụp hình ngay trong dashboard và upload. Sau khi chụp xong, nhấn upload, hình ảnh sẽ vào thư mục drive Ảnh thí nghiệm</p>
  </div>

  <!-- Mobile camera -->
  <div id="mobileCamera" style="display:none;">
    <p>Truy cập bằng điện thoại để chụp hình ngay trong dashboard và upload. Sau khi chụp xong, nhấn upload, hình ảnh sẽ vào thư mục drive Ảnh thí nghiệm</p>
    <input type="file" accept="image/*" capture="environment" id="cameraInput">
    <button id="uploadBtn">Upload (Mobile)</button>
  </div>
  <hr>
  <!-- SHEETS -->
  <h2>Theo dõi tiến độ hố khoan</h2>
  <p>Tiến độ hố khoan được hiển thị khi nhập sổ mở mẫu và số liệu thí nghiệm vào biểu Google Sheets trong thư mục Biểu nhập số thí nghiệm. Chọn tên hố khoan trong phần xổ xuống để hiện thị biểu có tên tương ứng.</p>
  <select id="sheetSelector"></select>
<div id="sheetContainer"></div>

<script>
async function loadSheets() {
  const response = await fetch("https://script.google.com/macros/s/AKfycbxicVGWO8hV0Lk90vrKqQV7w-Z-kNQWhvFcBzzSSDgVfN3ASR2vb4tcPB8qFgl4zHoT/exec");
  const sheets = await response.json();
  const selector = document.getElementById("sheetSelector");

  // tạo option
  sheets.forEach(sheet => {
    const opt = document.createElement("option");
    opt.value = sheet.url;
    opt.textContent = sheet.name;
    selector.appendChild(opt);
  });

  selector.addEventListener("change", () => {
    document.getElementById("sheetContainer").innerHTML =
      `<iframe src="${selector.value}" width="100%" height="600" frameborder="0"></iframe>`;
  });
}

loadSheets();
</script>


  <!-- Form + Sheets -->
  <h2>Công việc & Theo dõi</h2>
  <p>Mỗi ngày, các TNV điền thông tin và đánh dấu các công đoạn tham gia vào Google Form và gửi đi, dữ liệu sẽ được lưu lại và thống kê.</p>
  <!-- Google Form -->
  <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSfRll9yQzmv5t9OHBKAZFYpNKtb6chKqn8lcJ3nfc1U8NFEiA/viewform?embedded=true"></iframe>
  <p>Sau khi nhận được dữ liệu từ Google Form, biểu Google Sheets sau đây sẽ xử lý dữ liệu đó và tính điểm cho từng TNV theo từng ngày và tính điểm trung bình theo số ngày tùy chọn.</p>

  <!-- Google Sheets -->
  <iframe src="https://docs.google.com/spreadsheets/d/1t6ZJf5wu2iSf5spfFx-fP8tT9-AZUEQ-17xUn8YiSMo/edit?usp=sharing"></iframe>
  <hr>
  <h2>Các biểu quan trọng</h2> 
  <p>Biểu hiển thị ở dashboard chỉ để theo dõi, tránh chỉnh sửa. Nếu muốn chỉnh sửa, vui lòng truy cập vào các link sau và yêu cầu cấp quyền truy cập để đảm bảo tính bảo mật.</p>
  <div class="folder-links">
    <a href="https://docs.google.com/spreadsheets/d/15WLUyBcH235TF4f0KaM145X5Pv2kvi7DaqhyTAxg8rQ/edit?usp=sharing">Biểu theo dõi tiến độ hố khoan</a>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSfRll9yQzmv5t9OHBKAZFYpNKtb6chKqn8lcJ3nfc1U8NFEiA/viewform?usp=sharing&ouid=105033677416426965311">Form theo dõi công việc hàng ngày</a>
    <a href="https://docs.google.com/spreadsheets/d/1t6ZJf5wu2iSf5spfFx-fP8tT9-AZUEQ-17xUn8YiSMo/edit?usp=sharing">Biểu thống kê điểm của các TNV</a>
  </div>
  <p style="text-align: center; font-weight: bold; font-size: 22px;">
  ⋆｡‧˚ʚ🍓ɞ˚‧｡⋆CHÚC CÁC BẠN LÀM VIỆC HIỆU QUẢ VÀ VUI VẺ!⋆｡‧˚ʚ🍓ɞ˚‧｡⋆
</p>

  
</body>

<script>
  const isMobile = /Mobi|Android/i.test(navigator.userAgent);

  // Nếu là mobile thì hiện input upload
  if (isMobile) {
    document.getElementById('pcCamera').style.display = 'none';
    document.getElementById('mobileCamera').style.display = 'block';
  }

  // Mobile: upload từ input file
  const input = document.getElementById('cameraInput');
  const uploadBtn = document.getElementById('uploadBtn');
  if (uploadBtn) {
    uploadBtn.onclick = () => {
      if (!input.files.length) {
        alert("Chưa chọn ảnh");
        return;
      }
      const file = input.files[0];
      const ext = file.name.split('.').pop().toLowerCase();   // lấy đuôi gốc
      const reader = new FileReader();
      reader.onloadend = () => {
        uploadImage(reader.result, "mobile_" + Date.now() + "." + ext);
      };
      reader.readAsDataURL(file);
    };
  }
  // Hàm resize & upload
  function uploadImage(dataUrl, filename, maxWidth = 1024, maxHeight = 1024) {
    const img = new Image();
    img.onload = () => {
      let width = img.width;
      let height = img.height;
      const ratio = Math.min(maxWidth / width, maxHeight / height, 1);
      width *= ratio;
      height *= ratio;

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      const resizedDataUrl = canvas.toDataURL("image/jpeg", 0.8);
      const mimeMatch = resizedDataUrl.match(/^data:(image\/\w+);base64,/);
      const mimeType = mimeMatch ? mimeMatch[1] : "image/jpeg";
      const base64Data = resizedDataUrl.replace(/^data:image\/\w+;base64,/, "").replace(/\s/g, "");

      fetch("/.netlify/functions/uploadProxy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          image: base64Data,
          filename: filename,
          mimeType: mimeType
        })
      })
      .then(res => res.json())
      .then(txt => {
        if(txt.status === "success") {
          alert("Uploaded: " + txt.fileUrl);
        } else {
          alert("Upload error: " + txt.message);
        }
      })
      .catch(err => alert("Upload failed: " + err));
    };
    img.src = dataUrl;
  }
</script>
  
</html>
















